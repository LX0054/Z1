<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>月度收入明细</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 20px;
  background: linear-gradient(to bottom, #fff5f5, #ffeaea);
  color: #4a1f1f;
}
h1 {
  text-align: center;
  color: #b71c1c;
  margin-bottom: 20px;
  font-size: 2em;
  text-shadow: 1px 1px 2px #ffa0a0;
}
.table-container {
  width: 95%;
  overflow-x: auto;
  margin: 20px auto;
  border-radius: 12px;
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  background-color: #fff0f0;
  padding: 15px;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.95em;
}
th, td {
  padding: 12px 18px;
  border: 1px solid #f4c2c2;
  text-align: center;
}
th {
  background-color: #f16b6b;
  color: #fff;
  text-transform: uppercase;
}
tr:nth-child(even) { background-color: #ffeaea; }
tr.total-row td { font-weight: bold; font-size:1.1em; background-color: #fcdcdc; }
canvas { max-width: 900px; width: 95%; margin: 20px auto; background-color: #fff0f0; border-radius: 12px; padding: 15px; box-shadow: 0 6px 18px rgba(0,0,0,0.12);}
.red { color: red; font-weight: bold; }
.green { color: green; font-weight: bold; }
</style>
</head>
<body>

<h1 id="title">月度收入明细</h1>

<canvas id="monthChart"></canvas>

<div class="table-container">
  <table id="monthTable">
    <thead>
      <tr>
        <th>日期</th>
        <th>总计</th>
        <th>现金</th>
        <th>刷卡</th>
        <th>外卖</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="table-container">
  <h2 style="text-align:center;">历年同月对比</h2>
  <table id="compareTable">
    <thead>
      <tr>
        <th>年份</th>
        <th>营业额 (€)</th>
        <th>对比上一年</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const dailyCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS44fu207p7ozNnrKdTTWzKnovereIUNb1eCx8qMViyXU_yjqm7l3uhCSvsxOdCXkfq_IrlYAHEQv3_/pub?gid=907541600&single=true&output=csv';
const monthlyCsvUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vS44fu207p7ozNnrKdTTWzKnovereIUNb1eCx8qMViyXU_yjqm7l3uhCSvsxOdCXkfq_IrlYAHEQv3_/pub?gid=113778029&single=true&output=csv';

const urlParams = new URLSearchParams(window.location.search);
const selectedMonth = urlParams.get('month'); // 例如 2025年9月

async function fetchCsv(url) {
  const response = await fetch(url);
  const text = await response.text();
  return Papa.parse(text, { header:true, skipEmptyLines:true }).data;
}

function renderDailyChart(data) {
  const labels = data.map(r=>r['日期']).reverse();
  const totals = data.map(r=>parseFloat(r['总计'].replace(/[^\d.-]/g,''))||0).reverse();
  new Chart(document.getElementById('monthChart'), {
    type:'line',
    data:{ labels, datasets:[{
      label: selectedMonth+' 每日总计',
      data: totals,
      borderColor:'hsl(0,70%,50%)',
      backgroundColor:'hsla(0,70%,50%,0.2)',
      fill:true,
      tension:0.3
    }]},
    options:{ responsive:true, plugins:{ legend:{position:'top'} }, scales:{ y:{beginAtZero:true,title:{display:true,text:'收入 (€)'}} } }
  });
}

function renderDailyTable(data) {
  const tbody = document.querySelector('#monthTable tbody');
  tbody.innerHTML='';
  data.forEach(row=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${row['日期']}</td>
      <td style="font-weight:bold;font-size:1.1em;">${row['总计']}</td>
      <td>${row['现金']}</td>
      <td>${row['刷卡']}</td>
      <td>${row['外卖']}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderCompareTable(monthlyData, monthNum){
  const tbody=document.querySelector('#compareTable tbody');
  tbody.innerHTML='';
  const years=Object.keys(monthlyData).sort();
  let prevValue=null;
  years.forEach(y=>{
    const value=monthlyData[y][monthNum]||0;
    let pctText='';
    let cls='';
    if(prevValue!==null){
      const pct=(value-prevValue)/prevValue*100;
      pctText=(pct>0?'+':'')+pct.toFixed(0)+'%';
      cls=pct>0?'red':'green';
    }
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${y}</td>
      <td>${value.toLocaleString()} €</td>
      <td class="${cls}">${pctText}</td>
    `;
    tbody.appendChild(tr);
    prevValue=value;
  });
}

(async()=>{
  // 渲染每日表格和折线图
  const dailyData = await fetchCsv(dailyCsvUrl);
  const monthData = dailyData.filter(r=>r['日期'].startsWith(selectedMonth));
  document.getElementById('title').textContent = selectedMonth+' 月度收入明细';
  renderDailyTable(monthData);
  renderDailyChart(monthData);

  // 渲染历年同月对比表格
  const monthlyDataRaw = await fetchCsv(monthlyCsvUrl);
  const monthlyData={};
  monthlyDataRaw.forEach(row=>{
    const year=row['日期'].substring(0,4);
    const mMatch=row['日期'].match(/(\d+)月/);
    if(!mMatch) return;
    const m=parseInt(mMatch[1]);
    if(!monthlyData[year]) monthlyData[year]={};
    monthlyData[year][m]=parseFloat(row['总计'].replace(/[^\d.-]/g,''))||0;
  });
  const monthNumMatch=selectedMonth.match(/(\d+)月/);
  const monthNum=monthNumMatch?parseInt(monthNumMatch[1]):1;
  renderCompareTable(monthlyData, monthNum);
})();
</script>
</body>
</html>
